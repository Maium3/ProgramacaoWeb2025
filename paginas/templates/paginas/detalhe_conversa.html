{% extends "paginas/index.html" %}
{% load static %}

{% block conteudo %}
<style>
.chat-container {
    max-height: 600px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #080a39;
}
.message {
    margin-bottom: 10px;
}
.message-bubble {
    display: inline-block;
    max-width: 70%;
    padding: 10px;
    border-radius: 10px;
    word-wrap: break-word;
}
.message.text-end .message-bubble {
     /* roxo gradiente base (fallback com background-color) */
    background-image: linear-gradient(135deg, #8a2be2 0%, #7b2cff 45%, #4b0082 100%);
    background-color: #6610f2;
    background-size: cover;
    color: #fff;
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}
<!--.message-bubble {
    /* roxo gradiente base (fallback com background-color) */
    background-image: linear-gradient(135deg, #8a2be2 0%, #7b2cff 45%, #4b0082 100%);
    background-color: #6610f2;
    background-size: cover;
    color: #fff;
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}-->

/* gradiente levemente diferente para mensagens enviadas (alinha à direita) */
.message.text-end .message-bubble {
    background-image: linear-gradient(135deg, #6f4bd6 0%, #5a3fae 60%, #3e1f89 100%) !important;
    color: #fff !important;
}

.message:not(.text-end) .message-bubble {
    background-color: #605496 !important;
}
.send-message-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}
</style>


<p><strong>Universo:</strong> {{ object.universo }}</p>
<p><strong>Personagens:</strong> {{ object.personagens.all|join:", " }}</p>

<h4>Mensagens</h4>
<div class="chat-container" style="width: 1200px; height: 400px;">
    {% for mensagem in mensagens %}
    <div class="message {% if mensagem.enviada_por.criado_por == user %}text-end{% else %}text-start{% endif %}">
        <div class="message-bubble">
            <strong>{{ mensagem.enviada_por }}</strong><br>
            {{ mensagem.conteudo }}<br>
            <small>{{ mensagem.enviada_em|date:'d/m/Y H:i:s' }}</small>
        </div>
    </div>
    {% empty %}
    <div class="message">
        <div class="message-bubble bg-light">
            Nenhuma mensagem nesta conversa.
        </div>
    </div>
    {% endfor %}

    <p class="mt-3 text-center">
        {# Formulário de envio rápido: posta para a view MessageCreate existente (enviar_mensagem)
           Inclui um campo select para escolher qual personagem do usuário envia a mensagem
           e um hidden input com o id da conversa. #}
        <form action="{% url 'enviar_mensagem' %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="conversa_origem" value="{{ object.pk }}">

            <div class="input-group" style="max-width:900px; margin:0 auto;">
                <select name="enviada_por" class="form-select" required style="max-width:220px;">
                    <option value="">Escolha o personagem</option>
                    {% for p in meus_personagens %}
                        <option value="{{ p.pk }}">{{ p.nome }}</option>
                    {% empty %}
                        <option value="">(Nenhum personagem criado)</option>
                    {% endfor %}
                </select>
                <input type="text" name="conteudo" class="form-control" placeholder="Digite sua mensagem..." required>
                <button type="submit" class="btn btn-primary">Enviar</button>
            </div>
        </form>
    </p>

</div>

<a class="btn btn-secondary btn-lg mt-3" href="{% url 'listar_conversas' %}">Voltar para lista de conversas</a>
{% endblock conteudo %}
